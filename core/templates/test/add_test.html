{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-3xl mx-auto p-6">
    <!-- Заголовок с анимацией -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center transform transition duration-300 hover:scale-105">
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
            {% if editing %}Редактирование{% else %}Создание{% endif %} теста
        </span>
    </h1>
    
    <!-- Основная форма с улучшенными стилями -->
    <div class="bg-white rounded-xl shadow-xl overflow-hidden transition duration-300 hover:shadow-2xl">
        <form method="post" class="space-y-6 p-8" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Основные поля теста -->
            <div class="space-y-4">
                <!-- Название теста -->
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Название теста
                    </label>
                    {% render_field form.title class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" %}
                    {% if form.title.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.title.errors }}</div>
                    {% endif %}
                </div>
                
                <!-- Описание теста -->
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        Описание теста
                    </label>
                    {% render_field form.description class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" rows="3" %}
                </div>
                
                <!-- Предмет -->
                <div class="form-group">
                    <label for="{{ form.subject.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        Предмет
                    </label>
                    {% render_field form.subject class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" %}
                </div>
                
                <!-- Есть ли варианты -->
                <div class="form-group flex items-center">
                    {% render_field form.has_variants class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 transition duration-300" %}
                    <label for="{{ form.has_variants.id_for_label }}" class="ml-2 text-gray-700 cursor-pointer flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Тест имеет варианты
                    </label>
                </div>
            </div>
            
            <!-- Секция вариантов -->
            <div id="variants-section" class="space-y-4 {% if not form.has_variants.value %}hidden{% endif %}">
                <h3 class="text-xl font-medium text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                    Варианты теста
                </h3>
                
                <!-- Управление formsets -->
                {{ variant_formset.management_form }}
                {% if variant_formset.non_form_errors %}
                    <div class="text-red-500 mb-4 p-2 bg-red-50 rounded-lg">
                        {{ variant_formset.non_form_errors }}
                    </div>
                {% endif %}
                
                <div id="variants-container" class="space-y-3">
                    {% for form in variant_formset %}
                        <div class="variant-group border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-all duration-200 group relative">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.title.id_for_label }}" class="block text-gray-700 mb-1">Название варианта</label>
                                {% render_field form.title class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" %}
                                {% if form.title.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="{{ form.description.id_for_label }}" class="block text-gray-700 mb-1">Описание варианта</label>
                                {% render_field form.description class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" %}
                            </div>
                            
                            {% if not forloop.first %}
                            <button type="button" class="remove-variant mt-2 text-sm text-red-500 hover:text-red-700 flex items-center transition-colors duration-200">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Удалить вариант
                            </button>
                            {% endif %}
                            
                            {% if form.DELETE %}
                                {{ form.DELETE }}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-variant" class="text-blue-600 hover:text-blue-800 flex items-center text-sm transition-colors duration-200">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Добавить вариант
                </button>
            </div>
            
            <!-- Кнопки отправки -->
            <div class="pt-6 border-t border-gray-100 flex justify-between">
                <a href="{% url 'test_list' %}" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Отмена
                </a>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    {% if editing %}Сохранить изменения{% else %}Создать тест{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Элементы управления
        const hasVariantsCheckbox = document.getElementById('id_has_variants');
        const variantsSection = document.getElementById('variants-section');
        const variantsContainer = document.getElementById('variants-container');
        const addVariantButton = document.getElementById('add-variant');
        const totalFormsInput = document.getElementById('id_variants-TOTAL_FORMS');
        
        // Инициализация счетчика вариантов
        let variantCount = variantsContainer.querySelectorAll('.variant-group').length;
        const formPrefix = 'variants';
        
        // Функция для обновления индексов в именах полей
        function updateFormIndices() {
            const forms = variantsContainer.querySelectorAll('.variant-group');
            forms.forEach((form, index) => {
                // Обновляем индексы в полях формы
                form.querySelectorAll('input, textarea, select').forEach(field => {
                    const name = field.name.replace(/variants-\d+-/, `variants-${index}-`);
                    field.name = name;
                    if (field.id) {
                        field.id = field.id.replace(/variants-\d+-/, `variants-${index}-`);
                    }
                });
                
                // Обновляем текст метки для удаления
                const removeBtn = form.querySelector('.remove-variant');
                if (removeBtn && index === 0 && forms.length === 1) {
                    removeBtn.style.display = 'none';
                }
            });
            
            // Обновляем счетчик форм
            variantCount = forms.length;
            totalFormsInput.value = variantCount;
        }
        
        // Показываем/скрываем секцию вариантов
        if (hasVariantsCheckbox) {
            hasVariantsCheckbox.addEventListener('change', function() {
                variantsSection.classList.toggle('hidden', !this.checked);
                if (this.checked && variantCount === 0) {
                    addNewVariantForm();
                }
            });
        }
        
        // Функция для создания нового варианта
        function addNewVariantForm() {
            const newIndex = variantCount;
            const newForm = document.createElement('div');
            newForm.className = 'variant-group border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-all duration-200 group relative';
            newForm.innerHTML = `
                <input type="hidden" name="${formPrefix}-${newIndex}-id" id="id_${formPrefix}-${newIndex}-id">
                
                <div class="form-group mb-3">
                    <label for="id_${formPrefix}-${newIndex}-title" class="block text-gray-700 mb-1">Название варианта</label>
                    <input type="text" name="${formPrefix}-${newIndex}-title" 
                           id="id_${formPrefix}-${newIndex}-title"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           required>
                </div>
                
                <div class="form-group">
                    <label for="id_${formPrefix}-${newIndex}-description" class="block text-gray-700 mb-1">Описание варианта</label>
                    <textarea name="${formPrefix}-${newIndex}-description" 
                              id="id_${formPrefix}-${newIndex}-description"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                              rows="2"></textarea>
                </div>
                
                <button type="button" class="remove-variant mt-2 text-sm text-red-500 hover:text-red-700 flex items-center transition-colors duration-200">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Удалить вариант
                </button>
                
                <input type="hidden" name="${formPrefix}-${newIndex}-DELETE" id="id_${formPrefix}-${newIndex}-DELETE">
            `;
            
            variantsContainer.appendChild(newForm);
            updateFormIndices();
            
            // Прокрутка и фокус на новом поле
            newForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            newForm.querySelector(`#id_${formPrefix}-${newIndex}-title`).focus();
        }
        
        // Обработчик добавления варианта
        addVariantButton.addEventListener('click', addNewVariantForm);
        
        // Обработчик удаления варианта
        variantsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-variant')) {
                const variantGroup = e.target.closest('.variant-group');
                const deleteInput = variantGroup.querySelector('input[name$="-DELETE"]');
                
                if (variantsContainer.children.length > 1) {
                    if (deleteInput) {
                        // Помечаем для удаления
                        deleteInput.value = 'on';
                        variantGroup.style.opacity = '0.5';
                        variantGroup.style.pointerEvents = 'none';
                        e.target.textContent = 'Удалено (будет сохранено)';
                        e.target.classList.remove('text-red-500', 'hover:text-red-700');
                        e.target.classList.add('text-gray-500');
                    } else {
                        // Физическое удаление
                        variantGroup.remove();
                        updateFormIndices();
                    }
                } else {
                    alert('Тест должен содержать хотя бы один вариант');
                }
            }
        });
        
        // Инициализация при загрузке
        if (variantCount > 0 && variantsSection.classList.contains('hidden')) {
            variantsSection.classList.remove('hidden');
            if (hasVariantsCheckbox) {
                hasVariantsCheckbox.checked = true;
            }
        }
        
        // Скрываем кнопку удаления для первого варианта, если он один
        if (variantCount === 1) {
            const firstRemoveBtn = variantsContainer.querySelector('.variant-group:first-child .remove-variant');
            if (firstRemoveBtn) {
                firstRemoveBtn.style.display = 'none';
            }
        }
    });
    </script>
{% endblock %}